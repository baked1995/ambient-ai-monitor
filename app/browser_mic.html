<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Browser Microphone Recorder</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #fafafa;
    }

    input {
      padding: 8px;
      width: 260px;
      margin-bottom: 10px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    canvas {
      border: 1px solid #ccc;
      margin-top: 15px;
      width: 100%;
      max-width: 500px;
      height: 120px;
    }

    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h3>üé§ Live Browser Recording</h3>

<input id="speaker" placeholder="Speaker ID (e.g. harshit)" /><br>
<input id="category" placeholder="Category (voice, keyboard, noise)" /><br>

<button id="startBtn" onclick="startRecording()">‚ñ∂ Start</button>
<button id="stopBtn" onclick="stopRecording()" disabled>‚èπ Stop</button>

<div id="status">Idle</div>

<canvas id="waveform" width="500" height="120"></canvas>

<script>
let audioContext;
let analyser;
let dataArray;
let mediaRecorder;
let stream;
let chunks = [];
let animationId;

const canvas = document.getElementById("waveform");
const ctx = canvas.getContext("2d");

function drawWaveform() {
  animationId = requestAnimationFrame(drawWaveform);

  analyser.getByteTimeDomainData(dataArray);
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.beginPath();
  let sliceWidth = canvas.width / dataArray.length;
  let x = 0;

  for (let i = 0; i < dataArray.length; i++) {
    let v = dataArray[i] / 128.0;
    let y = (v * canvas.height) / 2;

    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);

    x += sliceWidth;
  }

  ctx.strokeStyle = "#007bff";
  ctx.lineWidth = 2;
  ctx.stroke();
}

async function startRecording() {
  const speaker = document.getElementById("speaker").value.trim();
  const category = document.getElementById("category").value.trim();

  if (!speaker || !category) {
    alert("Please enter speaker and category");
    return;
  }

  document.getElementById("status").innerText = "üéô Recording...";
  document.getElementById("startBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;

  stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  audioContext = new AudioContext();
  const source = audioContext.createMediaStreamSource(stream);

  analyser = audioContext.createAnalyser();
  analyser.fftSize = 2048;
  dataArray = new Uint8Array(analyser.fftSize);

  source.connect(analyser);
  drawWaveform();

  mediaRecorder = new MediaRecorder(stream);
  chunks = [];

  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) chunks.push(e.data);
  };

  mediaRecorder.start();
}

async function stopRecording() {
  document.getElementById("status").innerText = "‚è≥ Saving...";
  document.getElementById("stopBtn").disabled = true;

  mediaRecorder.stop();

  mediaRecorder.onstop = async () => {
    cancelAnimationFrame(animationId);

    stream.getTracks().forEach(track => track.stop());
    audioContext.close();

    const blob = new Blob(chunks, { type: "audio/wav" });

    const speaker = document.getElementById("speaker").value;
    const category = document.getElementById("category").value;

    const formData = new FormData();
    formData.append("file", blob, "recording.wav");
    formData.append("speaker", speaker);
    formData.append("category", category);

    try {
      const res = await fetch("/api/upload-audio", {
        method: "POST",
        body: formData
      });

      const result = await res.json();
      document.getElementById("status").innerText =
        "‚úÖ Saved: " + result.file;

    } catch (err) {
      document.getElementById("status").innerText =
        "‚ùå Upload failed";
    }

    document.getElementById("startBtn").disabled = false;
  };
}
</script>

</body>
</html>
