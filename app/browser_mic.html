<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Browser Mic Recorder</title>
  <style>
    body { font-family: Arial; text-align: center; }
    canvas { border: 1px solid #ccc; margin-top: 10px; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

<h3>üé§ Live Browser Recording</h3>

<label>Label:
  <input id="label" placeholder="e.g. keyboard, switch, harshit_voice">
</label>

<br><br>

<button onclick="startRecording()">‚ñ∂ Start</button>
<button onclick="stopRecording()">‚èπ Stop</button>

<div id="status"></div>

<canvas id="waveform" width="500" height="100"></canvas>

<script>
let audioContext, analyser, dataArray, recorder, stream;
let chunks = [];
const canvas = document.getElementById("waveform");
const ctx = canvas.getContext("2d");

function drawWaveform() {
  requestAnimationFrame(drawWaveform);
  analyser.getByteTimeDomainData(dataArray);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.beginPath();

  let sliceWidth = canvas.width / dataArray.length;
  let x = 0;

  for (let i = 0; i < dataArray.length; i++) {
    let v = dataArray[i] / 128.0;
    let y = (v * canvas.height) / 2;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    x += sliceWidth;
  }

  ctx.stroke();
}

async function startRecording() {
  document.getElementById("status").innerText = "üéô Recording...";
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  audioContext = new AudioContext();
  const source = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 2048;
  dataArray = new Uint8Array(analyser.fftSize);

  source.connect(analyser);
  drawWaveform();

  recorder = new MediaRecorder(stream);
  chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.start();
}

async function stopRecording() {
  recorder.stop();
  stream.getTracks().forEach(track => track.stop());

  recorder.onstop = async () => {
    const blob = new Blob(chunks, { type: "audio/wav" });
    const label = document.getElementById("label").value || "unlabeled";

    const formData = new FormData();
    formData.append("file", blob, "recording.wav");
    formData.append("label", label);

    const res = await fetch("http://localhost:8000/upload-audio", {
      method: "POST",
      body: formData
    });

    const result = await res.json();
    document.getElementById("status").innerText =
      "‚úÖ Audio saved: " + result.filename;
  };
}
</script>

</body>
</html>
